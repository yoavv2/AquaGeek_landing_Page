---
interface Props {
	title: string;
	description?: string;
}

// Define the debug info type and extend globalThis
type DebugInfo = {
    rawUrl: string;
    headers: { [k: string]: string };
    userAgent: string | null;
    referrer: string | null;
    parsedUrl?: {
        full: string;
        origin: string;
        pathname: string;
        search: string;
        params: { [k: string]: string };
    };
    redirectTo?: string;
    error?: string;
};

// Extend globalThis
declare global {
    var debugInfo: DebugInfo | undefined;
}

const { 
	title,
	description = 'אקווה גיק - פתרונות מקצועיים לאקווריומים, כולל עיצוב, תחזוקה וייעוץ אישי למגוון סוגי אקווריומים.'
} = Astro.props;

// Initialize debug information
const debugInfo: DebugInfo = {
    rawUrl: Astro.request.url,
    headers: Object.fromEntries(Astro.request.headers),
    userAgent: Astro.request.headers.get('user-agent'),
    referrer: Astro.request.headers.get('referer')
};

try {
    // Handle fbclid parameter
    const url = new URL(Astro.request.url);
    debugInfo.parsedUrl = {
        full: url.toString(),
        origin: url.origin,
        pathname: url.pathname,
        search: url.search,
        params: Object.fromEntries(url.searchParams)
    };

    if (url.searchParams.has('fbclid')) {
        const params = new URLSearchParams(url.search);
        params.delete('fbclid');
        const newSearch = params.toString() ? `?${params.toString()}` : '';
        const redirectUrl = `${url.pathname}${newSearch}`;
        debugInfo.redirectTo = redirectUrl;
        return Astro.redirect(redirectUrl, 301);
    }
} catch (error: unknown) {
    debugInfo.error = error instanceof Error ? error.message : String(error);
    console.error('Error processing URL:', error);
}

// Add debug info to a global variable that we can access in the template
globalThis.debugInfo = debugInfo;

const socialImage = '/social-preview.jpg';
const siteUrl = 'https://aqua-geek-landing-page.vercel.app';
---

<!doctype html>
<html lang="he" dir="rtl">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content={description} />
		<meta name="keywords" content="אקווריום, אקווריומים, דגים, אקווה גיק, תחזוקת אקווריום, עיצוב אקווריום, ייעוץ אקווריום, אקווריום מים מלוחים, אקווריום מים מתוקים" />
		<meta name="author" content="אקווה גיק" />
		<meta name="robots" content="index, follow" />

		<!-- Open Graph meta tags for link preview -->
		<meta property="fb:app_id" content="1268336434581614" />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={`${siteUrl}${socialImage}`} />
		<meta property="og:url" content={siteUrl} />
		<meta property="og:type" content="website" />
		<meta property="og:image:width" content="1200" />
		<meta property="og:image:height" content="630" />
		<meta property="og:locale" content="he_IL" />
		<meta property="og:site_name" content="אקווה גיק" />

		<!-- Twitter Card meta tags -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={`${siteUrl}${socialImage}`} />
		<meta name="twitter:site" content="@aqua_geek" />
		<meta name="twitter:creator" content="@aqua_geek" />

		<!-- Canonical URL -->
		<link rel="canonical" href={siteUrl} />

		<!-- Favicon -->
		<link rel="icon" type="image/svg+xml" href=`${socialImage}` />
		<meta name="theme-color" content="#3182ce" />

		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>

		<!-- Structured Data for Local Business -->
		<script type="application/ld+json">
			{
				"@context": "https://schema.org",
				"@type": "LocalBusiness",
				"name": "אקווה גיק",
				"image": ["https://aqua-geek-landing-page.vercel.app/coral-hero-bg4.png?v=1"],
				"@id": "https://aqua-geek-landing-page.vercel.app",
				"url": "https://aqua-geek-landing-page.vercel.app",
				"telephone": "+972526383226",
				"priceRange": "₪₪-₪₪₪₪",
				"description": "אקווה גיק - פתרונות מקצועיים לאקווריומים, כולל עיצוב, תחזוקה וייעוץ אישי.",
				"logo": "https://aqua-geek-landing-page.vercel.app/AquaGeek_Logo.png",
				"sameAs": [
					"https://www.instagram.com/aquageeks/",
					"https://www.facebook.com/profile.php?id=100057490747892"
				],
				"address": {
					"@type": "PostalAddress",
					"addressCountry": "IL",
					"addressRegion": "Israel"
				},
				"geo": {
					"@type": "GeoCoordinates",
					"latitude": "31.7767",
					"longitude": "35.2345"
				},
				"openingHoursSpecification": {
					"@type": "OpeningHoursSpecification",
					"dayOfWeek": [
						"Sunday",
						"Monday",
						"Tuesday",
						"Wednesday",
						"Thursday"
					],
					"opens": "09:00",
					"closes": "18:00"
				},
				"areaServed": "Israel"
			}
		</script>

		<!-- Structured Data for Service -->
		<script type="application/ld+json">
			{
				"@context": "https://schema.org",
				"@type": "Service",
				"serviceType": "Aquarium Services",
				"provider": {
					"@type": "LocalBusiness",
					"name": "אקווה גיק"
				},
				"areaServed": "Israel",
				"hasOfferCatalog": {
					"@type": "OfferCatalog",
					"name": "Aquarium Services",
					"itemListElement": [
						{
							"@type": "Offer",
							"itemOffered": {
								"@type": "Service",
								"name": "תחזוקת אקווריום",
								"description": "שירותי תחזוקה שוטפת לאקווריומים"
							}
						},
						{
							"@type": "Offer",
							"itemOffered": {
								"@type": "Service",
								"name": "עיצוב אקווריום",
								"description": "תכנון ועיצוב אקווריומים מותאמים אישית"
							}
						},
						{
							"@type": "Offer",
							"itemOffered": {
								"@type": "Service",
								"name": "ייעוץ אקווריום",
								"description": "ייעוץ מקצועי להקמה ותחזוקת אקווריומים"
							}
						}
					]
				}
			}
		</script>
	</head>
	<body>
		{/* Temporarily show debug info in all environments */}
		<div style="background: #f0f0f0; padding: 10px; margin: 10px; font-family: monospace; direction: ltr; position: fixed; top: 0; left: 0; z-index: 9999; max-width: 100%; overflow: auto;">
			<h3>Debug Info:</h3>
			<pre>{JSON.stringify(debugInfo, null, 2)}</pre>
		</div>
		<slot />
	</body>
</html>

<style is:global>
	:root {
		--primary: #3182ce;
		--primary-dark: #2c5282;
		--text: #2d3748;
		--background: #f7fafc;
	}
	
	* {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}

	html {
		font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
			Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
		background: white;
		color: var(--text);
		overflow-x: hidden;
		width: 100%;
	}

	body {
		min-height: 100vh;
		width: 100%;
		overflow-x: hidden;
		position: relative;
	}
</style>
